dsl_version: 0.1.0
service:
  name: neutron-server
  ports:
    - {{ neutron.server_port }}
  containers:
    - name: neutron-server
      image: neutron-server
      probes:
        readiness: "true"
        liveness:
          command: "true"
          type: "exec"
      pre:
        - name: neutron-db-create
          dependencies:
            - {{ service.database }}
          type: single
          command: mysql -u root -p{{ db.root_password }} -h {{ address(service.database) }} -e 'create database `{{ neutron.db.name }}`;
                   grant all privileges on `{{ neutron.db.name }}`.* to "{{ neutron.db.username }}"@"%" identified by "{{ neutron.db.password }}"'
        - name: neutron-db-sync
          type: single
          command: neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head
          dependencies:
            - rabbitmq
            - neutron-db-create
          files:
            - neutron.conf
            - ml2-conf.ini
        - name: neutron-user-create
          dependencies:
            - keystone-create-project
          type: single
          command: openstack user create --project service --password {{ neutron.db.password }} {{ neutron.db.username }}
        - name: neutron-role-add
          dependencies:
            - neutron-user-create
          type: single
          command: openstack role add --project service --user {{ neutron.db.username }} admin
        - name: neutron-service-create
          dependencies:
            - keystone
          type: single
          command: openstack service create --name neutron --description "OpenStack Networking" network
        - name: neutron-public-endpoint-create
          dependencies:
            - neutron-service-create
          type: single
          command: openstack endpoint create --region RegionOne network public {{ address('neutron-server', neutron.server_port, external=True, with_scheme=True) }}
        - name: neutron-internal-endpoint-create
          dependencies:
            - neutron-service-create
          type: single
          command: openstack endpoint create --region RegionOne network internal http://{{ address('neutron-server') }}:{{ neutron.server_port.cont }}
        - name: neutron-admin-endpoint-create
          dependencies:
            - neutron-service-create
          type: single
          command: openstack endpoint create --region RegionOne network admin  http://{{ address('neutron-server') }}:{{ neutron.server_port.cont }}
      daemon:
        command: neutron-server --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini
        files:
          - neutron.conf
          - ml2-conf.ini
      post:
        - name: neutron-bootstrap-router
          type: single
          command: neutron --os-endpoint-type internal router-create {{ neutron.bootstrap.router.name }}

        # {% set int = neutron.bootstrap.internal %}
        # {% if int.enable %}
        - name: neutron-bootstrap-int-net-create
          type: single
          command: neutron --os-endpoint-type internal net-create {{ int.net_name }}
        - name: neutron-bootstrap-int-net-subnet-create
          type: single
          dependencies:
            - neutron-bootstrap-int-net-create
          command: neutron --os-endpoint-type internal subnet-create --name {{ int.subnet_name }} --gateway {{ int.gateway }} {{ int.net_name }} {{ int.network }}
        - name: neutron-bootstrap-int-net-add-route
          type: single
          dependencies:
            - neutron-bootstrap-router
            - neutron-bootstrap-int-net-subnet-create
          command: neutron --os-endpoint-type internal router-interface-add {{ neutron.bootstrap.router.name }} {{ int.subnet_name }}
        # {% endif %}

        # {% set ext = neutron.bootstrap.external %}
        # {% if ext.enable %}
        # {% if "changeme" not in [ext.network, ext.physnet, ext.gateway, ext.nameserver, ext.pool.start, ext.pool.end] %}
        - name: neutron-bootstrap-ext-net-create
          type: single
          command: neutron --os-endpoint-type internal net-create --router:external=True --share --provider:network_type flat --provider:physical_network {{ ext.physnet }} {{ ext.net_name }}
        - name: neutron-bootstrap-ext-subnet-create
          type: single
          dependencies:
            - neutron-bootstrap-ext-net-create
          command: neutron --os-endpoint-type internal subnet-create --name {{ ext.subnet_name }} --disable-dhcp --allocation-pool start={{ ext.pool.start }},end={{ ext.pool.end }} --dns-nameserver {{ ext.nameserver }} {{ ext.net_name }} {{ ext.network }}
        - name: neutron-bootstrap-ext-net-set-gateway
          type: single
          dependencies:
            - neutron-bootstrap-router
            - neutron-bootstrap-ext-subnet-create
          command: neutron --os-endpoint-type internal router-gateway-set {{ neutron.bootstrap.router.name }} {{ ext.net_name }}
        # {% endif %}
        # {% endif %}

files:
  neutron.conf:
    path: /etc/neutron/neutron.conf
    content: neutron.conf.j2
    perm: "0600"
  ml2-conf.ini:
    path: /etc/neutron/plugins/ml2/ml2_conf.ini
    content: ml2_conf.ini.j2
    perm: "0600"
