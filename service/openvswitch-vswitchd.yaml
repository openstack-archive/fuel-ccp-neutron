service:
  name: openvswitch-vswitchd
  host-net: true
  daemonset: true
  containers:
    - name: openvswitch-vswitchd
      image: openvswitch-vswitchd
      privileged: true
      probes:
        readiness: "true"
        liveness: "true"
      volumes:
        - name: ovs-socket
          type: host
          path: /run/openvswitch
        - name: modules
          type: host
          path: /lib/modules
      pre:
        - name: vswitchd-bootstrap
          command: modprobe openvswitch
        - name: vswitchd-port-forwarding
          command: echo 1 > /proc/sys/net/ipv4/ip_forward
        - name: vswitchd-check-ovs-db
          command: ovs-vsctl --no-wait show
          dependencies:
            - vswitchd-bootstrap
            - openvswitch-db
        - name: vswitchd-setup-ovs-bridge-ext
          command: /usr/local/bin/ovs-ensure-configured.sh {{ neutron.ext_bridge_name }} {{ neutron.external_interface }}
          dependencies:
            - vswitchd-check-ovs-db
        - name: vswitchd-setup-ovs-bridge-int
          command: /usr/local/bin/ovs-ensure-configured.sh {{ neutron.int_bridge_name }} {{ neutron.internal_interface }}
          dependencies:
            - vswitchd-check-ovs-db
      daemon:
        command: /usr/sbin/ovs-vswitchd unix:/run/openvswitch/db.sock --mlockall
        dependencies:
          - openvswitch-db
        files:
          - ovs-ensure-configured.sh
files:
  ovs-ensure-configured.sh:
    path: /usr/local/bin/ovs-ensure-configured.sh
    content: ovs-ensure-configured.sh
    perm: "0755"
